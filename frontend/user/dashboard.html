<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | BiblioTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .content-section { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-btn.active { @apply bg-cyan-600 text-white shadow-lg shadow-cyan-200; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes growBar {
            from {
                height: 0;
            }
            to {
                height: var(--bar-height);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <nav class="sticky top-0 z-[100] w-full bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-cyan-600 p-2 rounded-xl shadow-lg">
                        <i data-lucide="book-open" class="text-white" size="24"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tighter leading-none">BIBLIO<span class="text-cyan-600">TECH</span></h1>
                        <p class="text-[10px] font-bold text-slate-400 tracking-[0.2em] uppercase">Digital Library</p>
                    </div>
                </div>

                <div class="hidden md:flex items-center bg-slate-100 p-1.5 rounded-2xl gap-1">
                    <button onclick="showSection('api-section', this)" class="nav-btn active px-6 py-2.5 rounded-xl text-xs font-black flex items-center gap-2 transition-all uppercase tracking-wider">
                        <i data-lucide="key" size="16"></i> API Key
                    </button>
                    <button onclick="showSection('book-section', this)" class="nav-btn px-6 py-2.5 rounded-xl text-xs font-black flex items-center gap-2 transition-all text-slate-500 uppercase tracking-wider">
                        <i data-lucide="library" size="16"></i> Koleksi
                    </button>
                    <button onclick="showSection('loan-section', this)" class="nav-btn px-6 py-2.5 rounded-xl text-xs font-black flex items-center gap-2 transition-all text-slate-500 uppercase tracking-wider">
                        <i data-lucide="shopping-bag" size="16"></i> Pinjaman
                    </button>
                </div>

                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-end hidden sm:block">
                        <p id="userName" class="text-sm font-black text-slate-800">User</p>
                        <span class="text-[10px] font-bold text-cyan-600 uppercase">Member Aktif</span>
                    </div>
                    <div id="userInitial" class="w-10 h-10 bg-cyan-600 rounded-full flex items-center justify-center text-white font-black shadow-md">U</div>
                    <button onclick="logout()" class="p-2.5 rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                        <i data-lucide="log-out" size="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Realtime Statistics Dashboard -->
        <div class="mb-10">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Dashboard Statistik</h2>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                    <i data-lucide="activity" size="14"></i>
                    <span>Realtime Update</span>
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Books Card -->
                <div class="bg-white rounded-[24px] p-6 shadow-lg border border-slate-100 hover:shadow-xl transition-all group">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="book-open" class="text-blue-600" size="24"></i>
                        </div>
                        <span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">+12%</span>
                    </div>
                    <h3 class="text-3xl font-black text-slate-800 mb-1" id="totalBooks">2,847</h3>
                    <p class="text-xs text-slate-500 uppercase tracking-widest">Total Buku (Google Books)</p>
                </div>

                <!-- Active Loans Card -->
                <div class="bg-white rounded-[24px] p-6 shadow-lg border border-slate-100 hover:shadow-xl transition-all group">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="shopping-bag" class="text-cyan-600" size="24"></i>
                        </div>
                        <span class="text-xs font-black text-amber-600 bg-amber-50 px-2 py-1 rounded-full">Active</span>
                    </div>
                    <h3 class="text-3xl font-black text-slate-800 mb-1" id="activeLoans">8</h3>
                    <p class="text-xs text-slate-500 uppercase tracking-widest">Pinjaman Aktif</p>
                </div>

                <!-- Completed Loans Card -->
                <div class="bg-white rounded-[24px] p-6 shadow-lg border border-slate-100 hover:shadow-xl transition-all group">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="check-circle" class="text-emerald-600" size="24"></i>
                        </div>
                        <span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">+24%</span>
                    </div>
                    <h3 class="text-3xl font-black text-slate-800 mb-1" id="completedLoans">156</h3>
                    <p class="text-xs text-slate-500 uppercase tracking-widest">Selesai Pinjam</p>
                </div>

                <!-- API Usage Card -->
                <div class="bg-white rounded-[24px] p-6 shadow-lg border border-slate-100 hover:shadow-xl transition-all group">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="zap" class="text-purple-600" size="24"></i>
                        </div>
                        <span class="text-xs font-black text-purple-600 bg-purple-50 px-2 py-1 rounded-full">High</span>
                    </div>
                    <h3 class="text-3xl font-black text-slate-800 mb-1" id="apiUsage">1.2K</h3>
                    <p class="text-xs text-slate-500 uppercase tracking-widest">API Calls</p>
                </div>
            </div>

            <!-- Activity Chart -->
            <div class="bg-white rounded-[24px] p-8 shadow-lg border border-slate-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-black text-slate-800">Aktivitas 7 Hari Terakhir</h3>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 text-xs font-black bg-cyan-50 text-cyan-600 rounded-lg">Hari</button>
                        <button class="px-3 py-1 text-xs font-black text-slate-400 hover:bg-slate-50 rounded-lg">Minggu</button>
                        <button class="px-3 py-1 text-xs font-black text-slate-400 hover:bg-slate-50 rounded-lg">Bulan</button>
                    </div>
                </div>
                <div class="h-32 flex items-end justify-between gap-2" id="activityChart">
                    <!-- Chart bars will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <section id="api-section" class="content-section">
            <div class="max-w-2xl mx-auto bg-white rounded-[40px] shadow-xl p-10 border border-slate-100 text-center relative">
                <!-- Status Indicator -->
                <div id="apiKeyStatus" class="absolute top-6 right-6">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full border text-[10px] font-black uppercase tracking-widest" id="statusBadge">
                        <div class="w-2 h-2 rounded-full" id="statusDot"></div>
                        <span id="statusText">Checking...</span>
                    </div>
                </div>

                <div class="w-20 h-20 bg-cyan-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-cyan-600 rotate-3">
                    <i data-lucide="shield-check" size="40"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Personal API Key</h3>
                <p class="text-slate-500 mb-8 font-medium italic">Rahasiakan key ini. Digunakan untuk otentikasi sirkulasi buku.</p>
                
                <!-- API Key Display -->
                <div class="bg-slate-50 p-6 rounded-3xl mb-8 border-2 border-dashed border-slate-200">
                    <div id="apiKeyDisplayArea">
                        <div class="flex items-center justify-center py-8">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-slate-200 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="key" class="text-slate-400" size="32"></i>
                                </div>
                                <p class="text-slate-500 text-sm font-medium">Klik "Generate Key" untuk membuat API Key baru</p>
                            </div>
                        </div>
                        <code id="displayApiKey" class="text-cyan-600 font-mono text-xl font-bold break-all tracking-tighter hidden"></code>
                    </div>
                </div>
                
                <!-- Status Messages -->
                <div id="apiStatusMessage" class="hidden mb-6 p-4 rounded-2xl text-sm font-black"></div>
                
                <!-- Action Buttons -->
                <div class="flex gap-4">
                    <button onclick="generateNewKey()" id="generateBtn" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-cyan-600 transition-all uppercase tracking-widest text-xs">REGENERATE KEY</button>
                    <button onclick="copyApiKey()" class="px-6 bg-slate-100 text-slate-600 rounded-2xl hover:bg-slate-200 transition-all"><i data-lucide="copy"></i></button>
                </div>
                
                <!-- Help Text -->
                <div class="mt-6 text-xs text-slate-500">
                    <p class="mb-2"> <strong>Tips:</strong> API Key yang dinonaktifkan tidak dapat di-regenerate</p>
                    <p>Hubungi administrator jika API Key Anda dinonaktifkan</p>
                </div>
            </div>
        </section>

        <section id="book-section" class="content-section hidden">
            <!-- Advanced Search Section -->
            <div class="bg-gradient-to-br from-cyan-600 to-blue-600 rounded-[32px] p-8 md:p-12 text-white mb-10 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10">
                    <i data-lucide="search" size="180"></i>
                </div>
                
                <div class="relative z-10">
                    <h2 class="text-3xl md:text-4xl font-black mb-4">Temukan Buku Impianmu ðŸ“š</h2>
                    <p class="text-cyan-100 mb-8 text-lg">Jelajahi koleksi digital kami dengan fitur pencarian cerdas</p>
                    
                    <!-- Main Search Bar -->
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-2 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 relative">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/60" size="20"></i>
                                <input type="text" id="searchQuery" class="w-full p-4 pl-12 bg-transparent text-white placeholder-white/60 outline-none font-bold text-lg" placeholder="Ketik judul, penulis, atau ISBN...">
                            </div>
                            <button onclick="fetchBooksPublic()" class="px-8 py-4 bg-white text-cyan-600 rounded-xl font-black shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                                <i data-lucide="search" size="20"></i>
                                <span>CARI SEKARANG</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Filters -->
                    <div class="flex flex-wrap gap-3">
                        <span class="text-white/80 text-sm font-bold">Cepat:</span>
                        <button onclick="quickSearch('programming')" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-black hover:bg-white/30 transition-all">Programming</button>
                        <button onclick="quickSearch('design')" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-black hover:bg-white/30 transition-all">Design</button>
                        <button onclick="quickSearch('business')" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-black hover:bg-white/30 transition-all">Business</button>
                        <button onclick="quickSearch('fiction')" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-black hover:bg-white/30 transition-all">Fiction</button>
                        <button onclick="quickSearch('science')" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-black hover:bg-white/30 transition-all">Science</button>
                    </div>
                </div>
            </div>

            <!-- Search Results Header -->
            <div id="searchResultsHeader" class="hidden mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-2xl font-black text-slate-800">Hasil Pencarian</h3>
                        <p class="text-slate-500 text-sm mt-1">Menampilkan <span id="resultCount" class="font-black text-cyan-600">0</span> buku</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="sortBooks('title')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-black hover:bg-slate-50 transition-all">A-Z</button>
                        <button onclick="sortBooks('date')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-black hover:bg-slate-50 transition-all">Terbaru</button>
                        <button onclick="toggleView()" class="px-4 py-2 bg-cyan-50 text-cyan-600 rounded-xl text-sm font-black hover:bg-cyan-100 transition-all">
                            <i data-lucide="grid" size="16"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Books Grid -->
            <div id="bookListContainer" class="hidden">
                <div id="bookList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                
                <!-- Loading State -->
                <div id="loadingState" class="hidden">
                    <div class="flex flex-col items-center justify-center py-20">
                        <div class="w-16 h-16 bg-cyan-100 rounded-full flex items-center justify-center mb-4 animate-spin">
                            <i data-lucide="loader" class="text-cyan-600" size="32"></i>
                        </div>
                        <p class="text-slate-500 font-black">Sedang mencari buku...</p>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden">
                    <div class="text-center py-20">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="search-x" class="text-slate-400" size="40"></i>
                        </div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Tidak Ada Hasil</h4>
                        <p class="text-slate-500 mb-6">Coba kata kunci lain atau periksa ejaan</p>
                        <button onclick="clearSearch()" class="px-6 py-3 bg-cyan-600 text-white rounded-xl font-black hover:bg-cyan-700 transition-all">Bersihkan Pencarian</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="loan-section" class="content-section hidden">
            <!-- Authentication Card -->
            <div id="loanAuth" class="max-w-lg mx-auto">
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[32px] p-10 text-center shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-10">
                        <i data-lucide="shield-check" size="120"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <div class="w-20 h-20 bg-cyan-500/20 rounded-3xl flex items-center justify-center mx-auto mb-6 animate-pulse-slow">
                            <i data-lucide="lock" class="text-cyan-400" size="40"></i>
                        </div>
                        <h3 class="text-2xl font-black text-white mb-3">Verifikasi Diperlukan</h3>
                        <p class="text-slate-400 mb-8 text-sm">Masukkan API Key Anda untuk mengakses riwayat peminjaman buku</p>
                        
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-1 mb-6">
                            <input type="text" id="inputApiKeyLoan" 
                                   class="w-full p-4 bg-transparent text-white placeholder-slate-400 rounded-xl text-center font-mono outline-none focus:bg-white/10 transition-all" 
                                   placeholder="Paste API Key di sini">
                        </div>
                        
                        <button onclick="fetchLoansWithKey()" 
                                class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="unlock" size="20"></i>
                            <span>BUKA RIWAYAT PEMINJAMAN</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loan History -->
            <div id="loanList" class="hidden">
                <!-- Header Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-[24px] p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                <i data-lucide="book-open" size="24"></i>
                            </div>
                            <span class="text-xs font-black bg-white/20 px-2 py-1 rounded-full">Total</span>
                        </div>
                        <h3 class="text-3xl font-black mb-1" id="totalLoanCount">0</h3>
                        <p class="text-xs text-blue-100 uppercase tracking-widest">Total Peminjaman</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-[24px] p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                <i data-lucide="clock" size="24"></i>
                            </div>
                            <span class="text-xs font-black bg-white/20 px-2 py-1 rounded-full">Aktif</span>
                        </div>
                        <h3 class="text-3xl font-black mb-1" id="activeLoanCount">0</h3>
                        <p class="text-xs text-amber-100 uppercase tracking-widest">Sedang Dipinjam</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-[24px] p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                <i data-lucide="check-circle" size="24"></i>
                            </div>
                            <span class="text-xs font-black bg-white/20 px-2 py-1 rounded-full">Selesai</span>
                        </div>
                        <h3 class="text-3xl font-black mb-1" id="completedLoanCount">0</h3>
                        <p class="text-xs text-emerald-100 uppercase tracking-widest">Dikembalikan</p>
                    </div>
                </div>

                <!-- Table Header -->
                <div class="bg-white rounded-[32px] shadow-xl overflow-hidden border border-slate-100">
                    <div class="flex items-center justify-between p-8 border-b border-slate-100">
                        <div>
                            <h3 class="text-2xl font-black text-slate-800 tracking-tight">Riwayat Peminjaman</h3>
                            <p class="text-slate-500 text-sm mt-1">Semua aktivitas peminjaman buku Anda</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="refreshLoans()" class="px-4 py-2 bg-cyan-50 text-cyan-600 rounded-xl text-sm font-black hover:bg-cyan-100 transition-all flex items-center gap-2">
                                <i data-lucide="refresh-cw" size="16"></i>
                                Refresh
                            </button>
                            <button onclick="resetLoanAuth()" class="px-4 py-2 bg-red-50 text-red-500 rounded-xl text-sm font-black hover:bg-red-100 transition-all flex items-center gap-2">
                                <i data-lucide="lock" size="16"></i>
                                Kunci
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-8 py-4 text-left">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="book" size="16" class="text-slate-400"></i>
                                            <span class="text-xs font-black text-slate-600 uppercase tracking-widest">Judul Buku</span>
                                        </div>
                                    </th>
                                    <th class="px-8 py-4 text-left">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="calendar" size="16" class="text-slate-400"></i>
                                            <span class="text-xs font-black text-slate-600 uppercase tracking-widest">Tanggal Pinjam</span>
                                        </div>
                                    </th>
                                    <th class="px-8 py-4 text-left">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="alert-circle" size="16" class="text-slate-400"></i>
                                            <span class="text-xs font-black text-slate-600 uppercase tracking-widest">Jatuh Tempo</span>
                                        </div>
                                    </th>
                                    <th class="px-8 py-4 text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            <i data-lucide="activity" size="16" class="text-slate-400"></i>
                                            <span class="text-xs font-black text-slate-600 uppercase tracking-widest">Status</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="loanTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="detailModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden items-center justify-center z-[200] p-6">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col md:flex-row relative">
            <button onclick="closeDetailModal()" class="absolute top-6 right-6 z-10 bg-slate-100 p-2 rounded-full hover:bg-red-500 hover:text-white transition-all"><i data-lucide="x" size="20"></i></button>
            <div class="w-full md:w-2/5 bg-slate-100 p-10 flex items-center justify-center">
                <img id="detailImg" src="" class="w-full shadow-2xl rounded-2xl object-cover transform -rotate-2">
            </div>
            <div class="w-full md:w-3/5 p-10 overflow-y-auto">
                <span id="detailCategory" class="text-[10px] font-black text-cyan-600 bg-cyan-50 px-4 py-1.5 rounded-full uppercase tracking-widest">Kategori</span>
                <h3 id="detailTitle" class="text-3xl font-black text-slate-800 mt-4 mb-2 leading-tight">Judul Buku</h3>
                <p id="detailAuthors" class="text-sm font-bold text-slate-400 mb-8 uppercase tracking-widest">Penulis</p>
                <div id="detailDesc" class="text-sm text-slate-600 leading-relaxed italic mb-8 border-l-4 border-slate-100 pl-4">Deskripsi buku...</div>
                <button id="btnPinjamDariDetail" class="w-full bg-cyan-600 text-white py-5 rounded-2xl font-black shadow-xl shadow-cyan-200 hover:bg-cyan-700 transition-all uppercase tracking-widest text-xs">PINJAM BUKU INI SEKARANG</button>
            </div>
        </div>
    </div>

    <div id="loanModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[210] p-6">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-md w-full p-10 relative">
            <button onclick="closeLoanModal()" class="absolute top-8 right-8 text-slate-400 hover:text-red-500"><i data-lucide="x-circle" size="28"></i></button>
            <div class="text-center mb-8">
                <h3 class="text-2xl font-black text-slate-800">Ajukan Pinjam</h3>
                <p id="modalBookTitle" class="text-cyan-600 font-bold mt-2 text-sm italic line-clamp-1"></p>
            </div>
            <form id="loanForm" class="space-y-5">
                <input type="hidden" id="modalBookId">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block">API Key Anda</label>
                    <input type="text" id="loanApiKey" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none font-mono text-sm focus:border-cyan-500 transition-all" placeholder="Masukkan Key" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block">Tgl Pinjam</label>
                        <input type="date" id="loanDate" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block">Jatuh Tempo</label>
                        <input type="date" id="dueDate" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest text-xs mt-4 hover:bg-cyan-600 shadow-xl transition-all">Kirim Permintaan</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');
        let lastSearchResults = [];

        if (!token) window.location.href = '../index.html';

        lucide.createIcons();

        // 1. Navigation Logic
        function showSection(id, btn) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.add('text-slate-500');
            });
            btn.classList.add('active');
            btn.classList.remove('text-slate-500');
            
            lucide.createIcons();
        }

        // 2. API Key Management
        async function generateNewKey() {
            try {
                const res = await fetch(`${API_BASE}/auth/regenerate-api-key`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    // Success case
                    localStorage.setItem('api_key', data.api_key);
                    alert("âœ… API Key Baru Berhasil Dibuat!");
                    
                    // Show the API key and hide placeholder
                    document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.add('hidden');
                    document.getElementById('displayApiKey').innerText = data.api_key;
                    document.getElementById('displayApiKey').classList.remove('hidden');
                    
                    // Don't refresh status to keep the key visible
                    // The key should remain visible until user manually generates again
                } else {
                    // Handle various error cases
                    if (res.status === 403) {
                        // API Key dinonaktifkan oleh admin
                        if (data.message && data.message.includes('dinonaktifkan')) {
                            alert("ðŸš« AKSES DITOLAK!\n\nAPI Key Anda telah dinonaktifkan oleh Admin.\nHubungi administrator untuk mengaktifkan kembali API Key Anda.\n\nCatatan: Generate API Key hanya dapat dilakukan jika status API Key AKTIF.");
                        } else {
                            alert("ðŸš« AKSES DITOLAK!\n\nAnda tidak memiliki izin untuk generate API Key.\nSilakan hubungi administrator.");
                        }
                    } else if (res.status === 401) {
                        // Token expired atau tidak valid
                        alert("ðŸ” SESSION EXPIRED!\n\nSesi login Anda telah berakhir.\nSilakan login kembali.");
                        // Auto logout
                        setTimeout(() => {
                            logout();
                        }, 2000);
                    } else if (res.status === 404) {
                        // User tidak ditemukan
                        alert("âŒ USER TIDAK DITEMUKAN!\n\nAkun Anda tidak terdaftar dalam sistem.\nSilakan hubungi administrator.");
                    } else {
                        // Error lainnya
                        alert(`âŒ GAGAL GENERATE API KEY!\n\n${data.message || 'Terjadi kesalahan yang tidak diketahui.'}\n\nStatus Code: ${res.status}`);
                    }
                }
            } catch (err) { 
                console.error('Generate API Key Error:', err);
                alert("âš ï¸ KESALAHAN SISTEM!\n\nTidak dapat terhubung ke server.\nPeriksa koneksi internet Anda dan coba lagi."); 
            }
        }

        function copyApiKey() {
            const key = document.getElementById('displayApiKey').innerText;
            const fromStorage = localStorage.getItem('api_key');
            const keyToCopy = key.includes('*') ? fromStorage : key;
            if (!keyToCopy) return alert("Belum ada API Key!");
            navigator.clipboard.writeText(keyToCopy).then(() => alert("ðŸ“‹ Berhasil disalin!"));
        }

        // Check API Key Status
        async function checkApiKeyStatus() {
            const apiKey = localStorage.getItem('api_key');
            const statusBadge = document.getElementById('statusBadge');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const statusMessage = document.getElementById('apiStatusMessage');
            const generateBtn = document.getElementById('generateBtn');
            const displayApiKey = document.getElementById('displayApiKey');
            
            // Check if API key is currently visible (not hidden)
            const isKeyVisible = !displayApiKey.classList.contains('hidden');
            
            // Set initial checking status
            updateStatusUI('checking', 'Checking...');
            
            if (!apiKey) {
                updateStatusUI('none', 'No Key');
                showStatusMessage('info', 'Anda belum memiliki API Key. Generate API Key untuk mulai menggunakan fitur peminjaman.');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Hide API key display area and show placeholder
                document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                document.getElementById('displayApiKey').classList.add('hidden');
                return;
            }
            
            try {
                // Test API key by making a request to loans endpoint
                const res = await fetch(`${API_BASE}/loans/my-loans`, { 
                    headers: { 'x-api-key': apiKey, 'Authorization': `Bearer ${token}` } 
                });
                
                if (res.ok) {
                    // API Key is valid and active
                    updateStatusUI('active', 'Active');
                    showStatusMessage('success', 'API Key Anda aktif dan siap digunakan.');
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // Only change display if key is not currently visible
                    if (!isKeyVisible) {
                        // Keep placeholder visible, don't show key automatically
                        // User must click "Generate Key" to see the key
                        document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                        document.getElementById('displayApiKey').classList.add('hidden');
                    }
                } else if (res.status === 403) {
                    const data = await res.json();
                    if (data.message && data.message.includes('dinonaktifkan')) {
                        // API Key dinonaktifkan
                        updateStatusUI('disabled', 'Disabled');
                        showStatusMessage('error', 'ðŸš« API Key Anda telah dinonaktifkan oleh Admin. Generate API Key tidak dapat dilakukan hingga diaktifkan kembali.');
                        generateBtn.disabled = true;
                        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        
                        // Hide the key and show placeholder
                        document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                        document.getElementById('displayApiKey').classList.add('hidden');
                    } else {
                        // Other 403 error
                        updateStatusUI('error', 'Error');
                        showStatusMessage('error', 'Terjadi kesalahan saat memverifikasi API Key.');
                        generateBtn.disabled = true;
                        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        
                        // Show placeholder
                        document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                        document.getElementById('displayApiKey').classList.add('hidden');
                    }
                } else {
                    // Other errors
                    updateStatusUI('error', 'Error');
                    showStatusMessage('error', 'API Key tidak valid atau terjadi kesalahan server.');
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // Show placeholder
                    document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                    document.getElementById('displayApiKey').classList.add('hidden');
                }
            } catch (err) {
                // Network error
                updateStatusUI('error', 'Error');
                showStatusMessage('error', 'Tidak dapat terhubung ke server untuk memverifikasi API Key.');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Show placeholder
                document.getElementById('apiKeyDisplayArea').querySelector('.flex').classList.remove('hidden');
                document.getElementById('displayApiKey').classList.add('hidden');
            }
        }
        
        function updateStatusUI(status, text) {
            const statusBadge = document.getElementById('statusBadge');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            // Reset classes
            statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border text-[10px] font-black uppercase tracking-widest';
            statusDot.className = 'w-2 h-2 rounded-full';
            
            switch(status) {
                case 'active':
                    statusBadge.classList.add('bg-emerald-50', 'text-emerald-600', 'border-emerald-200');
                    statusDot.classList.add('bg-emerald-500', 'animate-pulse');
                    break;
                case 'disabled':
                    statusBadge.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                    statusDot.classList.add('bg-red-500');
                    break;
                case 'checking':
                    statusBadge.classList.add('bg-amber-50', 'text-amber-600', 'border-amber-200');
                    statusDot.classList.add('bg-amber-500', 'animate-pulse');
                    break;
                case 'error':
                    statusBadge.classList.add('bg-slate-100', 'text-slate-600', 'border-slate-200');
                    statusDot.classList.add('bg-slate-400');
                    break;
                case 'none':
                    statusBadge.classList.add('bg-slate-100', 'text-slate-500', 'border-slate-200');
                    statusDot.classList.add('bg-slate-300');
                    break;
            }
            
            statusText.innerText = text;
        }
        
        function showStatusMessage(type, message) {
            const statusMessage = document.getElementById('apiStatusMessage');
            
            // Reset classes
            statusMessage.className = 'mb-6 p-4 rounded-2xl text-sm font-black';
            
            switch(type) {
                case 'success':
                    statusMessage.classList.add('bg-emerald-50', 'text-emerald-700', 'border', 'border-emerald-200');
                    break;
                case 'error':
                    statusMessage.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
                    break;
                case 'info':
                    statusMessage.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
                    break;
                case 'warning':
                    statusMessage.classList.add('bg-amber-50', 'text-amber-700', 'border', 'border-amber-200');
                    break;
            }
            
            statusMessage.innerText = message;
            statusMessage.classList.remove('hidden');
        }

        // 3. Books Logic
        async function fetchBooksPublic() {
            const q = document.getElementById('searchQuery').value.trim();
            if(!q) return alert("Ketik judul buku!");

            // Show loading state
            document.getElementById('bookListContainer').classList.remove('hidden');
            document.getElementById('bookList').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('searchResultsHeader').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/books/search?q=${q}`);
                const result = await res.json();
                
                // Hide loading state
                document.getElementById('loadingState').classList.add('hidden');
                
                if(res.ok && result.data && result.data.length > 0) {
                    lastSearchResults = result.data;
                    
                    // Show results header
                    document.getElementById('searchResultsHeader').classList.remove('hidden');
                    document.getElementById('resultCount').innerText = result.data.length;
                    
                    // Display books
                    displayBooks(lastSearchResults);
                } else {
                    // Show empty state
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('searchResultsHeader').classList.add('hidden');
                }
            } catch (err) { 
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                alert('Gagal memuat data buku'); 
            }
        }

        function displayBooks(books) {
            const bookList = document.getElementById('bookList');
            bookList.classList.remove('hidden');
            
            bookList.innerHTML = books.map((b, index) => `
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm hover:shadow-2xl transition-all group transform hover:-translate-y-2"
                     style="animation: fadeInUp 0.5s ease-out ${index * 0.1}s both;">
                    <div class="relative overflow-hidden rounded-2xl mb-5 h-56 bg-slate-50 border border-slate-50">
                        <img src="${b.thumbnail || 'https://via.placeholder.com/150'}" 
                             class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-slate-900/40 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex items-end justify-center p-4">
                            <button onclick="viewBookDetail('${b.id}')" 
                                    class="bg-white text-slate-900 px-6 py-2.5 rounded-xl text-[10px] font-black tracking-widest shadow-lg transform hover:scale-105 transition-all">
                                <i data-lucide="eye" size="14" class="inline mr-1"></i>
                                DETAIL
                            </button>
                        </div>
                        <!-- Badge -->
                        <div class="absolute top-3 right-3 bg-emerald-500 text-white px-2 py-1 rounded-full text-[9px] font-black">
                            TERSEDIA
                        </div>
                    </div>
                    <h5 class="font-black text-slate-800 text-sm mb-1 truncate group-hover:text-cyan-600 transition-colors">${b.title}</h5>
                    <p class="text-[10px] text-slate-400 font-bold mb-5 uppercase truncate">${b.authors.join(', ')}</p>
                    <div class="flex gap-2 mb-3">
                        <span class="text-[8px] bg-cyan-50 text-cyan-600 px-2 py-1 rounded-full font-black">${b.categories?.[0] || 'UMUM'}</span>
                        <span class="text-[8px] bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-black">${b.pageCount || '200'} hal</span>
                    </div>
                    <button onclick="openLoanModal('${b.id}', '${b.title.replace(/'/g, "\\'")}')" 
                            class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white text-[10px] font-black py-3 rounded-xl group-hover:from-cyan-500 group-hover:to-blue-500 transition-all uppercase tracking-widest shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i data-lucide="shopping-bag" size="14" class="inline mr-1"></i>
                        PINJAM SEKARANG
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function quickSearch(category) {
            document.getElementById('searchQuery').value = category;
            fetchBooksPublic();
        }

        function sortBooks(sortBy) {
            currentSort = sortBy;
            let sorted = [...lastSearchResults];
            
            if (sortBy === 'title') {
                sorted.sort((a, b) => a.title.localeCompare(b.title));
            } else if (sortBy === 'date') {
                sorted.sort((a, b) => new Date(b.publishedDate || 0) - new Date(a.publishedDate || 0));
            }
            
            displayBooks(sorted);
        }

        function toggleView() {
            isGridView = !isGridView;
            const bookList = document.getElementById('bookList');
            
            if (isGridView) {
                bookList.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8';
            } else {
                bookList.className = 'space-y-4';
            }
            
            displayBooks(lastSearchResults);
        }

        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('bookListContainer').classList.add('hidden');
            document.getElementById('searchResultsHeader').classList.add('hidden');
        }

        function viewBookDetail(bookId) {
            const book = lastSearchResults.find(b => b.id === bookId);
            if (!book) return;

            document.getElementById('detailImg').src = book.thumbnail || 'https://via.placeholder.com/150';
            document.getElementById('detailTitle').innerText = book.title;
            document.getElementById('detailAuthors').innerText = book.authors.join(', ');
            document.getElementById('detailCategory').innerText = book.categories ? book.categories.join(', ') : 'UMUM';
            document.getElementById('detailDesc').innerHTML = book.description || '<i>Tanpa deskripsi.</i>';

            document.getElementById('btnPinjamDariDetail').onclick = () => {
                closeDetailModal();
                openLoanModal(book.id, book.title.replace(/'/g, "\\'"));
            };

            document.getElementById('detailModal').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function closeDetailModal() { document.getElementById('detailModal').classList.replace('flex', 'hidden'); }

        // 4. Loan Logic
        function openLoanModal(bookId, title) {
            document.getElementById('modalBookId').value = bookId;
            document.getElementById('modalBookTitle').innerText = title;
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('loanModal').classList.replace('hidden', 'flex');
        }

        function closeLoanModal() { document.getElementById('loanModal').classList.replace('flex', 'hidden'); }

        document.getElementById('loanForm').onsubmit = async (e) => {
            e.preventDefault();
            const apiKey = document.getElementById('loanApiKey').value.trim();
            const payload = {
                book_id: document.getElementById('modalBookId').value,
                loan_date: document.getElementById('loanDate').value,
                due_date: document.getElementById('dueDate').value
            };

            try {
                const res = await fetch(`${API_BASE}/loans/`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-api-key': apiKey,
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                if(res.ok) { 
                    alert("ðŸš€ Pengajuan Peminjaman Berhasil!"); 
                    closeLoanModal(); 
                } else {
                    const d = await res.json();
                    alert(d.message);
                }
            } catch (err) { alert("Sistem Error"); }
        }

        async function fetchLoansWithKey() {
            const apiKey = document.getElementById('inputApiKeyLoan').value.trim();
            if(!apiKey) return alert("Masukkan API Key Anda!");

            try {
                const res = await fetch(`${API_BASE}/loans/my-loans`, { 
                    headers: { 'x-api-key': apiKey, 'Authorization': `Bearer ${token}` } 
                });
                const result = await res.json();
                if(res.ok) {
                    document.getElementById('loanAuth').classList.add('hidden');
                    document.getElementById('loanList').classList.remove('hidden');
                    
                    const loans = result.data || [];
                    
                    // Update statistics cards
                    updateLoanStatistics(loans);
                    
                    // Display loans in table
                    displayLoans(loans);
                } else { 
                    alert(result.message || "API Key tidak valid"); 
                }
            } catch (err) { 
                alert('Error memuat riwayat peminjaman'); 
            }
        }
        
        function updateLoanStatistics(loans) {
            const totalLoans = loans.length;
            const activeLoans = loans.filter(l => l.status === 'dipinjam').length;
            const completedLoans = loans.filter(l => l.status === 'dikembalikan').length;
            
            // Animate counters
            animateValue('totalLoanCount', totalLoans);
            animateValue('activeLoanCount', activeLoans);
            animateValue('completedLoanCount', completedLoans);
        }
        
        function displayLoans(loans) {
            const statusConfig = {
                'pending': {
                    color: 'text-amber-600',
                    bg: 'bg-amber-50',
                    border: 'border-amber-200',
                    icon: 'clock',
                    label: 'Menunggu'
                },
                'dipinjam': {
                    color: 'text-blue-600',
                    bg: 'bg-blue-50',
                    border: 'border-blue-200',
                    icon: 'book-open',
                    label: 'Dipinjam'
                },
                'dikembalikan': {
                    color: 'text-emerald-600',
                    bg: 'bg-emerald-50',
                    border: 'border-emerald-200',
                    icon: 'check-circle',
                    label: 'Dikembalikan'
                }
            };
            
            document.getElementById('loanTableBody').innerHTML = loans.map((loan, index) => {
                const status = statusConfig[loan.status] || statusConfig['pending'];
                const isOverdue = loan.status === 'dipinjam' && new Date(loan.due_date) < new Date();
                
                return `
                    <tr class="hover:bg-slate-50 transition-all duration-200" style="animation: fadeInUp 0.3s ease-out ${index * 0.05}s both;">
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="book" size="16" class="text-slate-600"></i>
                                </div>
                                <div>
                                    <p class="font-black text-slate-800 text-sm mb-1">${loan.book_title}</p>
                                    <p class="text-[10px] text-slate-500 uppercase tracking-widest">ID: ${loan.book_id}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" size="14" class="text-slate-400"></i>
                                <div>
                                    <p class="text-xs text-slate-700 font-medium">${formatDate(loan.loan_date)}</p>
                                    <p class="text-[9px] text-slate-500">${formatTime(loan.loan_date)}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-2 ${isOverdue ? 'text-red-600' : ''}">
                                <i data-lucide="alert-circle" size="14" class="${isOverdue ? 'text-red-500' : 'text-slate-400'}"></i>
                                <div>
                                    <p class="text-xs text-slate-700 font-medium ${isOverdue ? 'text-red-600' : ''}">${formatDate(loan.due_date)}</p>
                                    <p class="text-[9px] ${isOverdue ? 'text-red-500' : 'text-slate-500'}">${isOverdue ? 'TERLAMBAT' : formatTime(loan.due_date)}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-6">
                            <div class="flex items-center justify-center">
                                <span class="px-3 py-1.5 ${status.bg} ${status.border} ${status.color} rounded-full text-[10px] font-black uppercase tracking-widest flex items-center gap-1.5">
                                    <i data-lucide="${status.icon}" size="12"></i>
                                    ${status.label}
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function refreshLoans() {
            const apiKey = localStorage.getItem('api_key');
            if (apiKey) {
                document.getElementById('inputApiKeyLoan').value = apiKey;
                fetchLoansWithKey();
            } else {
                alert('API Key tidak ditemukan. Silakan generate API Key terlebih dahulu.');
            }
        }

        function resetLoanAuth() {
            document.getElementById('loanAuth').classList.remove('hidden');
            document.getElementById('loanList').classList.add('hidden');
        }

        function logout() {
            // Clear all localStorage data
            localStorage.clear();
            
            // Stop statistics interval
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            
            // Redirect to login page
            window.location.href = '../index.html';
        }

        // 5. Realtime User Statistics
        let statsInterval;
        
        async function updateStatistics() {
            try {
                console.log('ðŸ”„ Updating statistics...');
                
                // Fetch user's actual loan statistics
                const apiKey = localStorage.getItem('api_key');
                console.log('ðŸ“‹ API Key found:', !!apiKey);
                
                let userStats = {
                    activeLoans: 0,
                    completedLoans: 0,
                    totalBooks: 0,
                    apiUsage: 0,
                    weeklyActivity: []
                };
                
                // Get user's loan data
                if (apiKey) {
                    try {
                        console.log('ðŸ“‹ Fetching loan data...');
                        const loanRes = await fetch(`${API_BASE}/loans/my-loans`, { 
                            headers: { 'x-api-key': apiKey, 'Authorization': `Bearer ${token}` } 
                        });
                        
                        console.log('ðŸ“‹ Loan API response status:', loanRes.status);
                        
                        if (loanRes.ok) {
                            const loanData = await loanRes.json();
                            const loans = loanData.data || [];
                            console.log('ðŸ“‹ Loan data:', loans);
                            
                            // Calculate actual statistics
                            userStats.activeLoans = loans.filter(l => l.status === 'dipinjam').length;
                            userStats.completedLoans = loans.filter(l => l.status === 'dikembalikan').length;
                            
                            console.log('ðŸ“‹ Active loans:', userStats.activeLoans);
                            console.log('ðŸ“‹ Completed loans:', userStats.completedLoans);
                            
                            // Generate weekly activity based on loan dates
                            userStats.weeklyActivity = generateWeeklyActivity(loans);
                        } else {
                            console.log('ðŸ“‹ Loan API failed');
                        }
                    } catch (err) {
                        console.log('ðŸ“‹ Failed to fetch loan stats:', err);
                    }
                } else {
                    console.log('ðŸ“‹ No API key found, skipping loan stats');
                }
                
                // Get total books from statistics API
                try {
                    console.log('ðŸ“š Fetching books statistics...');
                    const bookRes = await fetch(`${API_BASE}/books/statistics`);
                    console.log('ðŸ“š Books API response status:', bookRes.status);
                    
                    if (bookRes.ok) {
                        const bookData = await bookRes.json();
                        console.log('ðŸ“š Books API data:', bookData);
                        userStats.totalBooks = bookData.data ? bookData.data.totalBooks : 0;
                        console.log('ðŸ“š Total books set to:', userStats.totalBooks);
                    } else {
                        console.log('ðŸ“š Books API failed, using fallback');
                        userStats.totalBooks = await getTotalBooksCount();
                    }
                } catch (err) {
                    console.log('ðŸ“š Books API error, using fallback:', err);
                    userStats.totalBooks = await getTotalBooksCount();
                }
                
                // Simulate API usage based on user activity
                userStats.apiUsage = Math.floor(Math.random() * 500) + 100;
                
                // Update UI with real data
                animateValue('totalBooks', userStats.totalBooks);
                animateValue('activeLoans', userStats.activeLoans);
                animateValue('completedLoans', userStats.completedLoans);
                animateValue('apiUsage', userStats.apiUsage, true);
                
                // Update activity chart
                updateActivityChart(userStats.weeklyActivity.length > 0 ? userStats.weeklyActivity : generateMockData());
                
            } catch (err) {
                console.error('Statistics update failed:', err);
                // Use fallback data
                updateFallbackStats();
            }
        }
        
        function animateValue(id, end, isK = false) {
            const element = document.getElementById(id);
            const start = parseInt(element.innerText.replace(/[^0-9]/g, '')) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);
                
                element.innerText = isK ? 
                    (current >= 1000 ? (current/1000).toFixed(1) + 'K' : current) : 
                    current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        async function getTotalBooksCount() {
            try {
                const res = await fetch(`${API_BASE}/books/search?q=programming`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                return result.totalItems || 0;
            } catch (err) {
                return 0;
            }
        }
        
        function generateWeeklyActivity(loans) {
            const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
            const today = new Date();
            const activity = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Count loans for this day
                const dayLoans = loans.filter(loan => {
                    return loan.loan_date === dateStr || loan.due_date === dateStr || loan.return_date === dateStr;
                }).length;
                
                activity.push(dayLoans + Math.floor(Math.random() * 3)); // Add some randomness
            }
            
            return activity;
        }
        
        function updateFallbackStats() {
            // Get user info for personalized fallback
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userName = payload.name || 'User';
                
                // Generate personalized mock data based on user
                const baseNumber = userName.length * 10;
                
                animateValue('totalBooks', baseNumber * 50);
                animateValue('activeLoans', Math.floor(baseNumber / 10));
                animateValue('completedLoans', baseNumber * 5);
                animateValue('apiUsage', baseNumber * 20, true);
                updateActivityChart(generateMockData());
            } catch (err) {
                // Ultimate fallback
                animateValue('totalBooks', 100);
                animateValue('activeLoans', 2);
                animateValue('completedLoans', 15);
                animateValue('apiUsage', 50, true);
                updateActivityChart(generateMockData());
            }
        }
        
        function generateMockData() {
            return Array.from({length: 7}, () => Math.floor(Math.random() * 50) + 10);
        }
        
        function updateActivityChart(data) {
            const chart = document.getElementById('activityChart');
            const maxValue = Math.max(...data);
            const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
            
            chart.innerHTML = data.map((value, index) => `
                <div class="flex-1 flex flex-col items-center gap-2">
                    <div class="w-full bg-slate-100 rounded-t-lg relative overflow-hidden" style="height: 100%;">
                        <div class="absolute bottom-0 w-full bg-gradient-to-t from-cyan-500 to-cyan-400 rounded-t-lg transition-all duration-1000 ease-out"
                             style="height: ${(value/maxValue) * 100}%; animation: growBar 0.8s ease-out ${index * 0.1}s both;">
                        </div>
                    </div>
                    <span class="text-xs text-slate-500 font-black">${days[index]}</span>
                </div>
            `).join('');
        }
        
        // 6. Enhanced Search Features
        let searchTimeout;
        
        function setupSearchFeatures() {
            // Auto-search on type with debounce
            document.getElementById('searchQuery').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (e.target.value.trim().length >= 3) {
                        fetchBooksPublic();
                    }
                }, 500);
            });
            
            // Enter key search
            document.getElementById('searchQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    fetchBooksPublic();
                }
            });
        }
        
        // 7. Initialize Dashboard
        function initializeDashboard() {
            // Update user info
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('userName').innerText = payload.name;
                document.getElementById('userInitial').innerText = payload.name.charAt(0).toUpperCase();
            } catch(e) { }
            
            // Check API Key status first
            checkApiKeyStatus();
            
            // Start realtime statistics
            updateStatistics();
            statsInterval = setInterval(updateStatistics, 30000); // Update every 30 seconds
            
            // Setup search features
            setupSearchFeatures();
            
            // Show API section by default
            showSection('api-section', document.querySelector('.nav-btn'));
            
            // Add keyboard shortcuts
            setupKeyboardShortcuts();
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K for search focus
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('searchQuery').focus();
                }
                
                // Escape to clear search
                if (e.key === 'Escape') {
                    clearSearch();
                }
                
                // Alt + 1/2/3 for navigation
                if (e.altKey) {
                    switch(e.key) {
                        case '1':
                            document.querySelector('.nav-btn').click();
                            break;
                        case '2':
                            document.querySelectorAll('.nav-btn')[1].click();
                            break;
                        case '3':
                            document.querySelectorAll('.nav-btn')[2].click();
                            break;
                    }
                }
            });
        }
        
        // 8. Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });
        
        // Initialize everything when DOM is ready
        initializeDashboard();

    </script>
</body>
</html>